



##  18.1 C语言的数据类型和对齐方式

| **C数据类型** | **描述**       | **RV32中字节数** | **RV64中字节数** |
| ------------- | -------------- | ---------------- | ---------------- |
| `char`        | 字符值/字节    | 1                | 1                |
| `short`       | 短整型         | 2                | 2                |
| `int`         | 整型           | 4                | 4                |
| `long`        | 长整型         | 4                | 8                |
| `long long`   | 超长整型       | 8                | 8                |
| `void*`       | 指针           | 4                | 8                |
| `float`       | 单精度浮点型   | 4                | 4                |
| `double`      | 双精度浮点型   | 8                | 8                |
| `long double` | 扩展精度浮点型 | 16               | 16               |

表18.1：基于RISC-V指令集的C编译器数据类型



## 18.2 RVG调用协定

| **寄存器** | **ABI名称**   | **描述**                             | **保存者** |
| ---------- | ------------- | ------------------------------------ | ---------- |
| x0         | zero          | 硬布线零                             |            |
| x1         | ra            | 返回地址                             | 调用者     |
| x2         | sp            | （用户）栈指针                       | 被调用者   |
| x3         | gp            | 全局指针                             |            |
| x4         | tp            | 线程指针                             |            |
| x5-7       | t0-2          | 临时暂存单元                         | 调用者     |
| x8         | s0/fp         | 保留寄存器/帧指针                    | 被调用者   |
| x9         | s1            | 保留寄存器                           | 被调用者   |
| x10-11     | a0-1          | 函数参数/返回值                      | 调用者     |
| x12-17     | a2-7          | 函数参数                             | 调用者     |
| x18-27     | s2-11         | 保留寄存器                           | 被调用者   |
| x28-31     | t3-6          | 临时暂存单元                         | 调用者·    |
| f0-7       | ft0-7         | 浮点临时暂存单元                     | 调用者     |
| f8-9       | fs0-1         | 浮点保留寄存器                       | 被调用者   |
| f10-11     | fa0-1         | 浮点参数/返回值                      | 调用者     |
| f12-17     | fa2-7         | 浮点参数                             | 调用者     |
| f18-27     | fs2-11        | 浮点保留寄存器                       | 被调用者   |
| f28-31     | ft8-11        | 浮点临时暂存单元                     | 调用者     |
| --------   | --------      | -----------------------------        | --------   |
|            | status        | 记录先前的cpu模式                    |            |
|            | satp          | 页表指针（==0表示禁用）              |            |
|            | tp            | 记录每个cpu的硬件id/线程指针         |            |
|            | epc           | 用户程序计数器，通过mret返回的地址？ |            |
|            | sp            | 用户栈指针                           |            |
|            | kernel_satp   | 进入内核使用的页表指针               |            |
|            | kernel_sp     | 进程内核栈的栈顶                     |            |
|            | kernel_trap   | usertrap()                           |            |
|            | kernel_hartid | saved kernel tp                      |            |
|            |               |                                      |            |

表18.2 RISC-V调用协定寄存器的使用

- `stvec`：内核在这里写入其陷阱处理程序的地址；RISC-V跳转到这里处理陷阱。
- `sepc`：当发生陷阱时，RISC-V会在这里保存程序计数器`pc`（因为`pc`会被`stvec`覆盖）。`sret`（从陷阱返回）指令会将`sepc`复制到`pc`。内核可以写入`sepc`来控制`sret`的去向。
- `scause`： RISC-V在这里放置一个描述陷阱原因的数字。
- `sscratch`：内核在这里放置了一个值，这个值在陷阱处理程序一开始就会派上用场。
- `sstatus`：其中的**SIE**位控制设备中断是否启用。如果内核清空**SIE**，RISC-V将推迟设备中断，直到内核重新设置**SIE**。**SPP**位指示陷阱是来自用户模式还是管理模式，并控制`sret`返回的模式。

